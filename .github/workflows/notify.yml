name: SKIMA watcher

on:
  workflow_dispatch:
    inputs:
      reason:
        description: Called by Deno.cron
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    concurrency:
      group: skima-watch
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: pip install requests beautifulsoup4

      # ── ① ハッシュ計算（ファイルが無ければ空文字列）
      - id: hash
        run: |
          mkdir -p .cache
          if [ -f .cache/items.db ]; then
            echo "filehash=$(sha256sum .cache/items.db | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          else
            echo "filehash=init" >> $GITHUB_OUTPUT
          fi

      # ── ② キャッシュ復元（接頭辞はハイフン付き）
      - id: restore-cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: skima-watch-cache-${{ steps.hash.outputs.filehash }}
          restore-keys: skima-watch-cache-

      - run: python skima_watch.py
        env:
          IFTTT_KEY: ${{ secrets.IFTTT_KEY }}

      # ── キャッシュ保存（上書き）
      - name: save-cache
        uses: actions/cache/save@v4
        with:
          path: .cache
          key: skima-watch-cache-${{ steps.hash.outputs.filehash }}
