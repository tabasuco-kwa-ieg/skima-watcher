name: SKIMA watcher
on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    concurrency:
      group: skima-watch
      cancel-in-progress: false

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with: { python-version: '3.12' }

    - run: pip install requests beautifulsoup4

    # ── 1) まず接頭辞だけで復元
    - id: restore-cache
      uses: actions/cache@v4
      with:
        path: .cache
        # （キーはダミー。restore-keys だけで拾わせる）
        key: dummy-dont-care
        restore-keys: skima-watch-cache-

    # ── 2) スクリプト実行（items.db を書き換える）
    - run: python skima_watch.py
      env: { IFTTT_KEY: ${{ secrets.IFTTT_KEY }} }

    # ── 3) items.db のハッシュを計算（実行後なので確実に存在）
    - id: hash
      run: |
        HASH=$(sha256sum .cache/items.db | cut -d' ' -f1)
        echo "filehash=$HASH" >> "$GITHUB_OUTPUT"

    # ── 4) ハッシュ付きキーで保存（毎回ユニーク）
    - uses: actions/cache/save@v4
      with:
        path: .cache
        key: skima-watch-cache-${{ steps.hash.outputs.filehash }}
